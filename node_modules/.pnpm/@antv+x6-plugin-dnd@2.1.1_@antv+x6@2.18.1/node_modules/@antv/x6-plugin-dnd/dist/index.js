!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@antv/x6")):"function"==typeof define&&define.amd?define(["exports","@antv/x6"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).X6PluginDnd={},t.X6)}(this,(function(t,e){"use strict";class n extends e.View{get targetScroller(){return this.options.target.getPlugin("scroller")}get targetGraph(){return this.options.target}get targetModel(){return this.targetGraph.model}get snapline(){return this.options.target.getPlugin("snapline")}constructor(t){super(),this.name="dnd",this.options=Object.assign(Object.assign({},n.defaults),t),this.init()}init(){e.CssLoader.ensure(this.name,".x6-widget-dnd {\n  position: absolute;\n  top: -10000px;\n  left: -10000px;\n  z-index: 999999;\n  display: none;\n  cursor: move;\n  opacity: 0.7;\n  pointer-events: 'cursor';\n}\n.x6-widget-dnd.dragging {\n  display: inline-block;\n}\n.x6-widget-dnd.dragging * {\n  pointer-events: none !important;\n}\n.x6-widget-dnd .x6-graph {\n  background: transparent;\n  box-shadow: none;\n}\n"),this.container=document.createElement("div"),e.Dom.addClass(this.container,this.prefixClassName("widget-dnd")),this.draggingGraph=new e.Graph(Object.assign(Object.assign({},this.options.delegateGraphOptions),{container:document.createElement("div"),width:1,height:1,async:!1})),e.Dom.append(this.container,this.draggingGraph.container)}start(t,i){const o=i;o.preventDefault(),this.targetModel.startBatch("dnd"),e.Dom.addClass(this.container,"dragging"),e.Dom.appendTo(this.container,this.options.draggingContainer||document.body),this.sourceNode=t,this.prepareDragging(t,o.clientX,o.clientY);const s=this.updateNodePosition(o.clientX,o.clientY);this.isSnaplineEnabled()&&(this.snapline.captureCursorOffset({e:o,node:t,cell:t,view:this.draggingView,x:s.x,y:s.y}),this.draggingNode.on("change:position",this.snap,this)),this.delegateDocumentEvents(n.documentEvents,o.data)}isSnaplineEnabled(){return this.snapline&&this.snapline.isEnabled()}prepareDragging(t,e,n){const i=this.draggingGraph,o=i.model,s=this.options.getDragNode(t,{sourceNode:t,draggingGraph:i,targetGraph:this.targetGraph});s.position(0,0);let a=5;if(this.isSnaplineEnabled()&&(a+=this.snapline.options.tolerance||0),this.isSnaplineEnabled()||this.options.scaled){const t=this.targetGraph.transform.getScale();i.scale(t.sx,t.sy),a*=Math.max(t.sx,t.sy)}else i.scale(1,1);this.clearDragging(),o.resetCells([s]);const r=i.findViewByCell(s);r.undelegateEvents(),r.cell.off("changed"),i.fitToContent({padding:a,allowNewOrigin:"any",useCellGeometry:!1});const d=r.getBBox();this.geometryBBox=r.getBBox({useCellGeometry:!0}),this.delta=this.geometryBBox.getTopLeft().diff(d.getTopLeft()),this.draggingNode=s,this.draggingView=r,this.draggingBBox=s.getBBox(),this.padding=a,this.originOffset=this.updateGraphPosition(e,n)}updateGraphPosition(t,n){const i=document.body.scrollTop||document.documentElement.scrollTop,o=document.body.scrollLeft||document.documentElement.scrollLeft,s=this.delta,a=this.geometryBBox,r=this.padding||5,d={left:t-s.x-a.width/2-r+o,top:n-s.y-a.height/2-r+i};return this.draggingGraph&&e.Dom.css(this.container,{left:`${d.left}px`,top:`${d.top}px`}),d}updateNodePosition(t,e){const n=this.targetGraph.clientToLocal(t,e),i=this.draggingBBox;return n.x-=i.width/2,n.y-=i.height/2,this.draggingNode.position(n.x,n.y),n}snap({cell:t,current:e,options:n}){const i=t;if(n.snapped){const t=this.draggingBBox;i.position(t.x+n.tx,t.y+n.ty,{silent:!0}),this.draggingView.translate(),i.position(e.x,e.y,{silent:!0}),this.snapOffset={x:n.tx,y:n.ty}}else this.snapOffset=null}onDragging(t){const e=this.draggingView;if(e){t.preventDefault();const n=this.normalizeEvent(t),i=n.clientX,o=n.clientY;this.updateGraphPosition(i,o);const s=this.updateNodePosition(i,o),a=this.targetGraph.options.embedding.enabled,r=(a||this.isSnaplineEnabled())&&this.isInsideValidArea({x:i,y:o});if(a){e.setEventData(n,{graph:this.targetGraph,candidateEmbedView:this.candidateEmbedView});const t=e.getEventData(n);r?e.processEmbedding(n,t):e.clearEmbedding(t),this.candidateEmbedView=t.candidateEmbedView}this.isSnaplineEnabled()&&(r?this.snapline.snapOnMoving({e:n,view:e,x:s.x,y:s.y}):this.snapline.hide())}}onDragEnd(t){const n=this.draggingNode;if(n){const i=this.normalizeEvent(t),o=this.draggingView,s=this.draggingBBox,a=this.snapOffset;let r=s.x,d=s.y;a&&(r+=a.x,d+=a.y),n.position(r,d,{silent:!0});const g=this.drop(n,{x:i.clientX,y:i.clientY}),l=t=>{t?(this.onDropped(n),this.targetGraph.options.embedding.enabled&&o&&(o.setEventData(i,{cell:t,graph:this.targetGraph,candidateEmbedView:this.candidateEmbedView}),o.finalizeEmbedding(i,o.getEventData(i)))):this.onDropInvalid(),this.candidateEmbedView=null,this.targetModel.stopBatch("dnd")};e.FunctionExt.isAsync(g)?(this.undelegateDocumentEvents(),g.then(l)):l(g)}}clearDragging(){this.draggingNode&&(this.sourceNode=null,this.draggingNode.remove(),this.draggingNode=null,this.draggingView=null,this.delta=null,this.padding=null,this.snapOffset=null,this.originOffset=null,this.undelegateDocumentEvents())}onDropped(t){this.draggingNode===t&&(this.clearDragging(),e.Dom.removeClass(this.container,"dragging"),e.Dom.remove(this.container))}onDropInvalid(){const t=this.draggingNode;t&&this.onDropped(t)}isInsideValidArea(t){let e,n=null;const i=this.targetGraph,o=this.targetScroller;this.options.dndContainer&&(n=this.getDropArea(this.options.dndContainer));const s=n&&n.containsPoint(t);if(o)if(o.options.autoResize)e=this.getDropArea(o.container);else{const t=this.getDropArea(o.container);e=this.getDropArea(i.container).intersectsWithRect(t)}else e=this.getDropArea(i.container);return!s&&e&&e.containsPoint(t)}getDropArea(t){const n=e.Dom.offset(t),i=document.body.scrollTop||document.documentElement.scrollTop,o=document.body.scrollLeft||document.documentElement.scrollLeft;return e.Rectangle.create({x:n.left+parseInt(e.Dom.css(t,"border-left-width"),10)-o,y:n.top+parseInt(e.Dom.css(t,"border-top-width"),10)-i,width:t.clientWidth,height:t.clientHeight})}drop(t,n){if(this.isInsideValidArea(n)){const i=this.targetGraph,o=i.model,s=i.clientToLocal(n),a=this.sourceNode,r=this.options.getDropNode(t,{sourceNode:a,draggingNode:t,targetGraph:this.targetGraph,draggingGraph:this.draggingGraph}),d=r.getBBox();s.x+=d.x-d.width/2,s.y+=d.y-d.height/2;const g=this.snapOffset?1:i.getGridSize();r.position(e.GeometryUtil.snapToGrid(s.x,g),e.GeometryUtil.snapToGrid(s.y,g)),r.removeZIndex();const l=this.options.validateNode,h=!l||l(r,{sourceNode:a,draggingNode:t,droppingNode:r,targetGraph:i,draggingGraph:this.draggingGraph});return"boolean"==typeof h?h?(o.addCell(r,{stencil:this.cid}),r):null:e.FunctionExt.toDeferredBoolean(h).then((t=>t?(o.addCell(r,{stencil:this.cid}),r):null))}return null}onRemove(){this.draggingGraph&&(this.draggingGraph.view.remove(),this.draggingGraph.dispose())}dispose(){this.remove(),e.CssLoader.clean(this.name)}}!function(t,e,n,i){var o,s=arguments.length,a=s<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,i);else for(var r=t.length-1;r>=0;r--)(o=t[r])&&(a=(s<3?o(a):s>3?o(e,n,a):o(e,n))||a);s>3&&a&&Object.defineProperty(e,n,a)}([e.View.dispose()],n.prototype,"dispose",null),function(t){t.defaults={getDragNode:t=>t.clone(),getDropNode:t=>t.clone()},t.documentEvents={mousemove:"onDragging",touchmove:"onDragging",mouseup:"onDragEnd",touchend:"onDragEnd",touchcancel:"onDragEnd"}}(n||(n={})),t.Dnd=n}));
//# sourceMappingURL=index.js.map
